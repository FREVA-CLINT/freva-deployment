stages:
    - doc
    - release

lint:
    image: python
    stage: doc
    needs: []
    tags:
        - docker, specific
    before_script:
        - python3 -m pip install .[test]
    script:
        - mypy --install-types --non-interactive
        - black --check src

pages:
    image: python
    stage: doc
    needs: []
    tags:
        - docker, specific
    script:
        - cd docs && make html
    before_script:
        - python3 -m pip install .[docs]
    after_script:
        - mv docs/_build/html public
    artifacts:
        when: always
        paths:
            - public

release_job:
    stage: release
    image: python
    needs: ["pages"]
    tags:
        - docker, specific
    rules:
        - if: $CI_COMMIT_TAG
    before_script:
        - pip install twine
    script:
        - python setup.py sdist
        - TWINE_PASSWORD=${CI_JOB_TOKEN}
          TWINE_USERNAME=gitlab-ci-token
          python -m twine upload --repository-url
          ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
    release:
        tag_name: '$CI_COMMIT_TAG'
        description: '$CI_COMMIT_TAG'
