
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Transitioning of the Plugins &#8212; freva-deployment 2505.0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=04ffed07"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'after-deployment/TransitionPlugins';</script>
    <link rel="canonical" href="http://127.0.0.1:8000/after-deployment/TransitionPlugins.html" />
    <link rel="icon" href="../_static/freva_owl.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Appendix III: Legal notes as flat-pages" href="LegalNotes.html" />
    <link rel="prev" title="Transitioning guide" href="TransitionService.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/freva_owl.svg" class="logo__image only-light" alt="freva-deployment 2505.0.1 documentation - Home"/>
    <img src="../_static/freva_owl.svg" class="logo__image only-dark pst-js-only" alt="freva-deployment 2505.0.1 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../architecture/index.html">
    Freva Architecture and Configuration Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../deployment/index.html">
    The freva-deployment software
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    After successful deployment
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../faq.html">
    Frequently Asked Questions (FAQ)
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../whatsnew.html">
    What’s new
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/FREVA-CLINT/freva-deployment" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/freva-deployment" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../architecture/index.html">
    Freva Architecture and Configuration Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../deployment/index.html">
    The freva-deployment software
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    After successful deployment
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../faq.html">
    Frequently Asked Questions (FAQ)
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../whatsnew.html">
    What’s new
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/FREVA-CLINT/freva-deployment" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/freva-deployment" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-custom fa-pypi fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AfterDeployment.html">Activation scripts and module files for users</a></li>

<li class="toctree-l1"><a class="reference internal" href="TransitionService.html">Transitioning guide</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Transitioning of the Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="LegalNotes.html">Appendix III: Legal notes as flat-pages</a></li>
</ul>
</div>
</nav></div>
        <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">After successful deployment</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Transitioning of the Plugins</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="transitioning-of-the-plugins">
<h1>Transitioning of the Plugins<a class="headerlink" href="#transitioning-of-the-plugins" title="Link to this heading">#</a></h1>
<p>The Freva plugins are an essential part of Freva.
Most likely the transitioning from the old python2 to the new python3 based
system, needs special care. A complete rewrite of the plugin manager is planned.
This section should therefore be seen as intermediate solutions for plugin transitioning.</p>
<p>Currently we recommend creating an anaconda environment for each plugin.
This approach has several advantages:</p>
<ul class="simple">
<li><p>reproducible as each plugin will get a anaconda environment file.</p></li>
<li><p>no version and dependency conflicts occur.</p></li>
<li><p>once set up easy to maintain.</p></li>
</ul>
<p>These are the disadvantages of this method:</p>
<ul class="simple">
<li><p>an anaconda environment file has to be created for each plugin.</p></li>
</ul>
<section id="transitioning-steps">
<h2>Transitioning steps:<a class="headerlink" href="#transitioning-steps" title="Link to this heading">#</a></h2>
<p>There are multiple ways of how you can get your old plugin back to the new
Freva system. We do recommend a deployment strategy involving conda.
While this strategy is not strictly necessary it offers the best as
possible reproducibility and is host system independent.
Meaning your plugins can be easily transitioned to other institutions and
are more likely to work after major system updates on your host system.
Here we briefly cover the steps that are needed to bring your old plugin back
to life in the new Freva system. We will also discuss alternatives
to using conda. Regardless of choice on using conda or not the first two
steps will be necessary.</p>
<section id="common-steps">
<h3>Common steps:<a class="headerlink" href="#common-steps" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>clone the repository of a plugin, change into the directory and create a new branch.</p></li>
<li><p>export the user plugin variable:</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">export EVALUATION_SYSTEM_PLUGINS=$PWD/path_to_wrapper_file,class_name</span>
<span class="go">freva plugin -l</span>
</pre></div>
</div>
<p>Most certainly, the plugin manager will output a warning that the plugin could
not be loaded. If it does, change the plugin accordingly to make the
warning messages go away.</p>
</section>
<section id="a-using-conda">
<h3>a. Using conda:<a class="headerlink" href="#a-using-conda" title="Link to this heading">#</a></h3>
<p>As mentioned above this step has the advantage that you increase the reproducibility
of your plugin. Transitioning your plugin to other institutions is also easy
because all libraries are encapsulated from the host system and hence independent.
While not strictly necessary it is a good idea to familiarise yourself with
<a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/index.html">anaconda</a>.</p>
<ol class="arabic simple" start="3">
<li><p>Download the <a class="reference external" href="https://swift.dkrz.de/v1/dkrz_3d3c7abc-1681-4012-b656-3cc1058c52a9/k204230/freva-transition/plugin-env.yml">conda environment file template</a> and the <a class="reference external" href="https://swift.dkrz.de/v1/dkrz_3d3c7abc-1681-4012-b656-3cc1058c52a9/k204230/freva-transition/Makefile">Makefile template</a></p></li>
<li><p>Add all dependencies to the <code class="docutils literal notranslate"><span class="pre">plugin-env.yml</span></code> file. In doubt search <a class="reference external" href="https://anaconda.org">anaconda.org</a> for dependencies.</p></li>
<li><p>If needed adjust the <code class="docutils literal notranslate"><span class="pre">build</span></code> step in the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> for compiling plugin dependencies, e.g. fortran dependencies.</p></li>
<li><p>Execute <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">all</span></code> to install the conda environment and build the plugin dependencies.</p></li>
<li><p>Execute the plugin and check if everything goes well.</p></li>
<li><p>Format the plugin using black: <code class="docutils literal notranslate"><span class="pre">black</span> <span class="pre">-t</span> <span class="pre">py310</span> <span class="pre">path_to_plugin.py</span></code></p></li>
</ol>
</section>
<section id="b-using-the-environment-of-freva">
<h3>b. Using the environment of freva<a class="headerlink" href="#b-using-the-environment-of-freva" title="Link to this heading">#</a></h3>
<p>If your plugin doesn’t need many libraries you can simply try to use everything
the comes with freva. This is the easiest way as you don’t have to do anything.
Simply try to execute all commands that come with your plugin and see what
happens.</p>
</section>
<section id="c-using-software-of-the-host-system">
<h3>c. Using software of the host system<a class="headerlink" href="#c-using-software-of-the-host-system" title="Link to this heading">#</a></h3>
<p>You can also make use of the software installed on the host system. For
example via spack. Many HPC systems offer the <code class="docutils literal notranslate"><span class="pre">module</span></code> command. Using this
approach will result in a plugin that is tailored around the current host system
you are using. Future updates may break usage and you defiantly won’t be able
to use your plugin at other institutions.</p>
</section>
</section>
<section id="transitioning-python2-plugins">
<h2>Transitioning <code class="docutils literal notranslate"><span class="pre">python2</span></code> plugins<a class="headerlink" href="#transitioning-python2-plugins" title="Link to this heading">#</a></h2>
<p>Python plugins (especially python2) need special care. The recommended strategy
is to convert the plugin content to python3. If this is not possible an anaconda
python2 environment should be created.</p>
<p>If in the original plugin the plugin code is directly executed in the <code class="docutils literal notranslate"><span class="pre">run_rool</span></code>
method (formerly named <code class="docutils literal notranslate"><span class="pre">runTool</span></code>) this code has to be split from the new <code class="docutils literal notranslate"><span class="pre">run_tool</span></code> method. The
transition strategy is gathering the essential information in a <code class="docutils literal notranslate"><span class="pre">json</span></code> file that
is passed to the actual core part of the plugin. The code below shows a simple
python2 plugin:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span><span class="w"> </span><span class="nf">runTool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the old `runTool` method.</span>
<span class="sd">    The plugin configuration is passed into this method and the code</span>
<span class="sd">    is directly executed in this method.&quot;&quot;&quot;</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">src.plugin</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">evaluation_system.model.file</span><span class="w"> </span><span class="kn">import</span> <span class="n">DRSFile</span>
    <span class="n">search_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;ensemble&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;ensemble&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;time_frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;time_frequency&quot;</span><span class="p">]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DRSFile</span><span class="o">.</span><span class="n">solr_search</span><span class="p">(</span><span class="n">path_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">search_kw</span><span class="p">))</span>
    <span class="n">calculate</span><span class="p">(</span><span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">],</span> <span class="n">files</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepareOutput</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>The above code should be split into two components, one that makes use of
<code class="docutils literal notranslate"><span class="pre">evaluation_system</span></code> to gather the data. And one that executes the actual plugin
code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_dict</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is the wrapper API part of the plugin.</span>
<span class="sd">    It gathers the plugin information and passes the needed information</span>
<span class="sd">    to the actual plugin code that is split into another python file.&quot;&quot;&quot;</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">evaluation_system.model.file</span><span class="w"> </span><span class="kn">import</span> <span class="n">DRSFile</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTemporaryFile</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
    <span class="n">search_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;ensemble&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;ensemble&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span>
    <span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;time_frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;time_frequency&quot;</span><span class="p">]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DRSFile</span><span class="o">.</span><span class="n">solr_search</span><span class="p">(</span><span class="n">path_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">search_kw</span><span class="p">))</span>
    <span class="n">compute_kw</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="n">search_kw</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">],</span>
                      <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
                      <span class="n">output_dir</span><span class="o">=</span><span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">]</span>
                <span class="p">)</span>
    <span class="k">with</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">):</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="o">**</span><span class="n">compute_kw</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;python2 </span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="s1">&#39;compute_python2&#39;</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_output</span><span class="p">(</span><span class="n">config_dict</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>The below code demonstrates the usage of the above created <code class="docutils literal notranslate"><span class="pre">json</span></code> file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;This file is the python2 plugin part.</span>
<span class="sd">This file calls the calculations of the python2 plugin. The configuration</span>
<span class="sd">is passed via a json file into this part.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">src.plugin</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Usage: </span><span class="si">{}</span><span class="s2"> path_to_json_file.json&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">calculate</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dir&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>If you want to use the json file in a bash script you must install the <code class="docutils literal notranslate"><span class="pre">jq</span></code>
json parser. Simply add <code class="docutils literal notranslate"><span class="pre">jq</span></code> to your <code class="docutils literal notranslate"><span class="pre">plugin-env.yml</span></code> file and read the
<a class="reference external" href="https://stedolan.github.io/jq/tutorial/">docs of jq</a>.</p>
</section>
<section id="after-conda-deployment-increasing-reproducibility-of-your-plugin">
<h2>After conda deployment: Increasing reproducibility of your plugin<a class="headerlink" href="#after-conda-deployment-increasing-reproducibility-of-your-plugin" title="Link to this heading">#</a></h2>
<p>If you have successfully deployed your plugin environment using conda you
can increase the reproducibility by “freezing” all packages that have
been installed by conda. This will increase the reproducibility of your package
because the versions of your packages will exactly match the one you are
using at this point in time. Every time you re-install the plugin environment
you will have the same dependency versions. To fix the package versions
execute the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">plugin_env</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">conda</span> <span class="nb">list</span>  <span class="o">--</span><span class="n">explicit</span> <span class="o">&gt;</span> <span class="n">spec</span><span class="o">-</span><span class="n">file</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Add and commit the created <code class="docutils literal notranslate"><span class="pre">spec-file.txt</span></code> to your repository. Afterwards
you can replace
<code class="docutils literal notranslate"><span class="pre">conda</span> <span class="pre">env</span> <span class="pre">create</span> <span class="pre">--prefix</span> <span class="pre">./plugin_env</span> <span class="pre">-f</span> <span class="pre">plugin-env.yml</span> <span class="pre">--force</span></code> in the <code class="docutils literal notranslate"><span class="pre">conda</span></code>
section of your <code class="docutils literal notranslate"><span class="pre">Makefile</span></code> by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">env</span> <span class="n">create</span> <span class="o">--</span><span class="n">prefix</span> <span class="o">./</span><span class="n">plugin_env</span> <span class="o">-</span><span class="n">f</span> <span class="n">spec</span><span class="o">-</span><span class="n">file</span><span class="o">.</span><span class="n">txt</span> <span class="o">--</span><span class="n">force</span>
</pre></div>
</div>
<p>And you’re done.</p>
</section>
<section id="problem-conda-doesn-t-finish-resolving-dependencies">
<h2>Problem: conda doesn’t finish resolving dependencies<a class="headerlink" href="#problem-conda-doesn-t-finish-resolving-dependencies" title="Link to this heading">#</a></h2>
<p>Sometimes conda is unable/won’t finish to solve all dependencies. You have a
couple of options in that case. First you can try replacing the <code class="docutils literal notranslate"><span class="pre">conda</span></code> command
by <code class="docutils literal notranslate"><span class="pre">mamba</span></code> in your Makefile. <code class="docutils literal notranslate"><span class="pre">mamba</span></code> is written in C and comes with a
different dependency solver. Most of the time switching from <code class="docutils literal notranslate"><span class="pre">conda</span></code> to <code class="docutils literal notranslate"><span class="pre">mamba</span></code>
solves the problem. If the issues persists with <code class="docutils literal notranslate"><span class="pre">mamba</span></code> you can try identifying
the problematic package(s). Usually by guessing which package(s) might be the
offending ones and removing them from the <code class="docutils literal notranslate"><span class="pre">plugin-env.yml</span></code> file. Once the
package(s) have been circled you can create an additional conda environment.
For example by adding the following line into the <code class="docutils literal notranslate"><span class="pre">conda</span></code> section of the
<code class="docutils literal notranslate"><span class="pre">Makefile</span></code>. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>conda create -c conda-forge -p ./plugin_env2 cdo netcdf-fortran
``

If you want to use resources from this environment in your plugin you need
to modify the environment in your API wrapper. Following the example
above, this modification could look like this:

```python
env = os.environ.copy()
this_dir = os.path.dirname(os.path.abspath(__file__))
env[&quot;PATH&quot;] = env[&quot;PATH&quot;] + &quot;:&quot; + os.path.join(this_dir, &quot;plugin_env2&quot;, &quot;bin&quot;)
env[&quot;LD_LIBRARY_PATH&quot;] = os.path.join(this_dir, &quot;plugin_env2&quot;, &quot;lib&quot;)
self.call(your_command_here, env=env)

</pre></div>
</div>
<p>If you need to compile additional libraries you probably also want to adjust
the <code class="docutils literal notranslate"><span class="pre">PATH</span></code> and <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> variable in the file that executes the compile
step to be able to pick up the <code class="docutils literal notranslate"><span class="pre">lib</span></code> and <code class="docutils literal notranslate"><span class="pre">bin</span></code> folders in the <code class="docutils literal notranslate"><span class="pre">plugin_env2</span></code>
conda environment.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="TransitionService.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Transitioning guide</p>
      </div>
    </a>
    <a class="right-next"
       href="LegalNotes.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Appendix III: Legal notes as flat-pages</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transitioning-steps">Transitioning steps:</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#common-steps">Common steps:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-using-conda">a. Using conda:</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-using-the-environment-of-freva">b. Using the environment of freva</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-using-software-of-the-host-system">c. Using software of the host system</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#transitioning-python2-plugins">Transitioning <code class="docutils literal notranslate"><span class="pre">python2</span></code> plugins</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#after-conda-deployment-increasing-reproducibility-of-your-plugin">After conda deployment: Increasing reproducibility of your plugin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#problem-conda-doesn-t-finish-resolving-dependencies">Problem: conda doesn’t finish resolving dependencies</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, DKRZ - CLINT.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>