---
- name: Pulling container
  shell: |
    {{ deployment_method }} stop {{ cache_name }} || true
    {{ deployment_method }} rm -f {{ cache_name }} || true
    {{ deployment_method }} rmi -f ghcr.io/freva-clint/freva-redis || true
    {{ deployment_method }} pull ghcr.io/freva-clint/freva-redis:{{redis_version}}
  changed_when: true

- name: Creating volumes
  include_tasks: "container-volumes.yml"

- name: Creating compose directory structure
  file:
    path: '{{ base_path }}/{{cache_name}}/compose_services'
    state: directory
    recurse: true
    owner: "{{ uid }}"
    group: "{{ gid }}"

- name: Creating compose file
  template:
    src: "caching-server-compose.j2"
    dest: "{{ compose_file }}"

- name: Creating system services
  script: >
    {{ asset_dir }}/scripts/create_systemd.py
    {{ cache_name }} compose --enable --project-name {{cache_name}}
    -f {{ compose_file }} up --remove-orphans
  environment:
    DEBUG: '{{ debug }}'
    PREFER: "{{deployment_method }}"
