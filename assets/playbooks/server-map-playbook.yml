---
- hosts: freva_map

  vars:
    - docker_cmd: "-v /mnt/freva/server-map:/var/freva/:z --name freva-map -p {{ port }}:5008 -t freva-map:latest"
  tasks:
    - name: Registering systemctl path
      stat:
        path: /usr/bin/systemctl
      register: systemctl
    - name: Stopping services
      shell: systemctl stop freva-map; systemctl stop freva-map; echo 0
      when: wipe == true
    - pause: seconds=2
    - name: Deleting existing contianer
      shell: docker stop freva-map; docker rm freva-map; docker rmi -f freva-map; echo 0
      become: yes
      when: wipe == true
    - name: Cleaning existing directory structure
      shell:
        cmd: rm -rf /mnt/freva/server-map/*.toml
        warn: false
      become: yes
      when: wipe == true
    - name: Copy systemd files
      copy:
        src: "{{ asset_dir }}/scripts/{{ item }}"
        dest: /tmp/{{ item }}
        mode: '0755'
      with_items:
        - "systemd.service"
        - "create_systemd.sh"
    - name: Copy docker kill script
      copy:
        src: "{{ asset_dir }}/scripts/kill_container"
        dest: /usr/local/bin/kill_container
        mode: '0755'
      become: yes
    - name: Copy auxillary files to target machine
      copy: src="{{ asset_dir }}/servers" dest=/tmp
    - name: Building docker images
      shell:
        chdir: /tmp/servers
        cmd: docker build -t freva-map:latest .
      become: yes
    - name: Creating directory structure
      shell:
        cmd: mkdir -p /mnt/freva/server-map
        warn: false
    - name: Change directory permissions
      shell:
        cmd: chown -R 9999:9999 /mnt/freva/server-map
        warn: false
      become: yes
    - name: Creating the freva-map docker container
      become: yes
      shell: docker run -d {{docker_cmd }}
    - name: Starting freva-map service
      become: yes
      shell:  cat /tmp/systemd.service|sed 's#%CONTAINER#freva-map#g'|sed 's#%PROJECT#freva-map#g' > /tmp/tmp_server && mv /tmp/tmp_server /etc/systemd/system/freva-map.service && /tmp/create_systemd.sh freva-map
      when: systemctl.stat.exists == true
    - pause: seconds=3
    - name: Deleting other files
      file:
        state: absent
        path: "{{ item }}"
      with_items:
        - /tmp/create_systemd.sh
        - /tmp/systemd.service
    - name: Delete temporary files
      shell:
        cmd: rm -rf /tmp/servers
        warn: false
