---
- hosts: core

  vars:
    - ansible_python_interpreter: "{{ core_ansible_python_interpreter }}"
    - ansible_become_user: "{{ core_ansible_become_user if core_ansible_become_user is defined else 'root' }}"
    - ansible_become: "{{'yes' if core_ansible_become_user is defined else 'no' }}"
  tasks:
  - name: Getting register to the freva logo
    stat:
      path: "{{ core_institution_logo }}"
    register: logo
  - name: Creating share directory
    shell:
      cmd: mkdir -p "{{core_root_dir}}/freva/web"
      warn: false
  - name: Copy the logo if exists
    copy:
      src: "{{ core_institution_logo }}"
      dest: "{{core_root_dir}}/freva/web/logo.{{web_institution_logo_suffix}}"
    when: logo.stat.exists == true
  - name: Adding freva web config to the core structure
    copy: src={{ core_config_toml_file }} dest={{ core_root_dir }}/freva/web/freva_web_conf.toml

- hosts: web

  vars:
    - ansible_python_interpreter: "{{ web_ansible_python_interpreter }}"
    - docker_cmd: "-p 8000:8000 -p 80:80 -p 443:443 -v /mnt/{{project_name}}/web_service:/srv/http:z -v {{ core_root_dir }}:{{ core_root_dir }}:z -v {{ core_root_dir }}/share/preview:/srv/http/static/preview:z --name"
    - container_name: "{{ project_name }}-web"
  tasks:
  - name: Creating /etc/containers/nodocker
    file:
      state: touch
      path: /etc/containers/nodocker
    ignore_errors: yes
    become: yes
  - name: Getting register to core dir
    stat:
      path: "{{ core_root_dir }}/freva/evaluation_system.conf"
    register: core
  - name: Registering systemctl path
    stat:
      path: /usr/bin/systemctl
    register: systemctl
  - name: Exit if core does not exist
    fail:
      msg: "Error: core not available on machine. The core hasn't been deployed yet, or wasn't mounted into its expected location: {{core_root_dir}}"
    when: core.stat.exists == false
  - name: Stopping services
    shell: docker stop {{container_name}}; docker rm {{container_name}}; systemctl stop {{ project_name }}; systemctl stop {{project_name}}-web; echo 0
    ignore_errors: yes
    become: yes
  - name: Creating docker network
    shell: docker network create "{{ project_name }}"; echo 0
    become: yes
  - name: Creating tmporary files
    shell:
      cmd: mkdir -p "/tmp/{{project_name}}_web"
      warn: false
  - name: Deleting existing web-directory
    file:
      state: absent
      path: /mnt/{{ project_name }}/web_service
    become: yes
  - name: Copy Dockerfile,entrypoint,freva_web.conf(apache conf) files
    copy:
      src:  "{{ asset_dir }}/web/{{ item }}"
      dest: "/tmp/{{project_name}}_web/{{ item }}"
      mode: '0755'
    with_items:
      - "Dockerfile"
      - "entrypoint.sh"
      - "docker_cmd.sh"
      - "freva_web.conf"
      - "create_web_conf.py"
      - "add-aur.sh"
      - "setup_web.sh"
  - name: Adjusting freva_web.conf
    shell:
      chdir: "/tmp/{{project_name}}_web"
      cmd: "{{ansible_python_interpreter}} create_web_conf.py freva_web.conf freva_web.conf --website={{web_project_website}} --root-dir={{core_root_dir}} --project-name={{project_name}} --alias={{web_server_alias}} --server-name={{web_host}}"
      warn: false
  - name: Build freva_web image
    become: yes
    shell:
      chdir: "/tmp/{{project_name}}_web"
      cmd: docker build --build-arg=core_url={{core_git_url}} --build-arg=core_branch={{core_branch}} --build-arg=build_root=/mnt/{{project_name}}/web_service --build-arg=git_url={{web_git_url}} --build-arg=git_branch={{web_branch}} --build-arg=root_dir={{core_root_dir}} --build-arg=PROJECT_NAME={{project_name}}  -t {{ container_name }} .
  - name: Moving temporary build folder to target destination
    become: yes
    shell:
      cmd: mkdir -p /mnt/{{project_name}}/web_service
      warn: false
  - name: Run freva_web image
    become: yes
    shell: "docker run -d {{docker_cmd}} {{container_name}} {{container_name}}"
  - name: Copy systemd files
    copy:
      src: "{{ asset_dir }}/scripts/{{ item }}"
      dest: /tmp/{{ item }}
      mode: '0755'
    with_items:
      - "systemd.service"
      - "create_systemd.sh"
  - name: Creating systemd service
    become: yes
    shell: "cat /tmp/systemd.service|sed 's#%CONTAINER#{{ container_name }}#g'|sed 's#%PROJECT#{{ project_name }}#g' > /tmp/tmp_db && mv /tmp/tmp_db /etc/systemd/system/{{ project_name }}-web.service && /tmp/create_systemd.sh {{project_name}}-web"
    when: systemctl.stat.exists == true
  - pause: seconds=5
  - name: Building django page
    become: yes
    shell: docker exec -it {{container_name}} /bin/bash /tmp/setup_web.sh {{root_passwd}} {{web_admin}}
  - name: Deleting tmporary files
    shell:
      cmd: rm -r /tmp/{{project_name}}_web
      warn: false
    become: yes
