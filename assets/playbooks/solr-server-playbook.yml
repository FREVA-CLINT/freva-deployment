---
- hosts: solr

  vars:
    - ansible_python_interpreter: "{{ solr_ansible_python_interpreter }}"
    - continer_name: "{{ solr_name }}"
    - docker_cmd: >
        "-e CORE={{solr_core}}"
        "-e NUM_BACKUPS=7"
        "-e SOLR_HEAP={{solr_mem}}"
        "-v /mnt/{{project_name}}/solr_service:/var/solr/data:z"
        "--name {{ solr_name }}"
        "-p {{ solr_port }}:8983 -t {{ solr_name }}:latest"
  tasks:
    - name: Copying docker/podman wrapper script
      copy:
        src: "{{ asset_dir }}/scripts/docker-or-podman"
        dest: /usr/local/bin/docker-or-podman
        mode: "0775"
      become: true
    - name: Registering systemctl path
      stat:
        path: /usr/bin/systemctl
      register: systemctl
    - name: Stopping services and deleting existing containers
      shell: >
        systemctl stop {{solr_name}};
        /usr/local/bin/docker-or-podman rm {{solr_name}};
        /usr/local/bin/docker-or-podman rmi -f {{solr_name}};
        exit 0
      ignore_errors: true
      become: true
    - pause: seconds=5
    - name: Creating docker network
      shell: >
        /usr/local/bin/docker-or-podman network create "{{ project_name }}";
        exit 0
      ignore_errors: true
      become: true
    - name: Cleaning existing directory structure
      file:
        path: /mnt/{{ project_name }}/solr_service
        state: absent
      become: true
      when: wipe == true
    - name: Creating directory structure
      file:
        path: /mnt/{{ project_name }}/solr_service
        state: directory
        owner: 8983
        group: 8983
        recurse: true
      become: true
    - name: Copy systemd files
      copy:
        src: "{{ asset_dir }}/scripts/create_systemd.py"
        dest: /tmp/create_systemd.py
        mode: "0755"
    - name: Copy auxillary files to target machine
      copy: src="{{ asset_dir }}/solr_service" dest=/tmp
    - name: Copy cron create script to target machine
      copy: src="{{ asset_dir }}/scripts/create_cron.sh" dest=/tmp/solr_service/
    - name: Building solr images
      shell:
        chdir: /tmp/solr_service
        cmd: /usr/local/bin/docker-or-podman build -t {{ solr_name }}:latest .
      become: true
    - name: Creating the solr docker container
      become: true
      shell: /usr/local/bin/docker-or-podman run -d {{docker_cmd}}
    - name: Starting solr service
      become: true
      shell: "/tmp/create_systemd.py {{solr_name}}"
      when: systemctl.stat.exists == true
    - pause: seconds=3
    - name: Creating the solr cores
      become: true
      shell: >
        /usr/local/bin/docker-or-podman exec -it --user=solr "{{solr_name}}"
        /bin/bash create_core.sh "{{item}}"
      with_items:
        - "latest"
        - "{{solr_core}}"
    - name: Restarting docker container
      become: true
      shell: systemctl restart "{{ solr_name }}"
      when: systemctl.stat.exists == true
    - name: Creating cron jobs
      become: true
      shell: sh /tmp/solr_service/create_cron.sh "{{ solr_name }}"
    - name: Deleting auxillary files
      file:
        state: absent
        path: "{{ item }}"
      with_items:
        - /tmp/create_systemd.py
        - /tmp/solr_service
